<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>大調音階｜三和弦級數練習</title>

<style>
/* ===== 手機直式優先（7 欄完整顯示）===== */
:root{
  --gap: 6px;
  --side: 12px;
  --cell: calc((100vw - (var(--side) * 2) - (var(--gap) * 6)) / 7);
}

*{ box-sizing:border-box; }

body{
  margin:0;
  background:#0f1115;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC",sans-serif;
}

.wrapper{
  max-width:480px;
  margin:0 auto;
  padding:12px;
}

h1{
  font-size:16px;
  text-align:center;
  margin:6px 0 10px;
}

/* ===== 7×3 空白格 ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(7,var(--cell));
  grid-template-rows:repeat(3,var(--cell));
  gap:var(--gap);
  justify-content:center;
  margin-bottom:14px;
}

.cell{
  width:var(--cell);
  height:var(--cell);
  border:1px dashed rgba(255,255,255,.4);
  border-radius:10px;
  position:relative;
}

.cell.highlight{
  border-color:#6fbaff;
  background:rgba(111,186,255,.15);
}

/* ===== 音名區 ===== */
.palette{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.row{
  display:grid;
  grid-template-columns:repeat(7,var(--cell));
  gap:var(--gap);
  justify-content:center;
}

.tile{
  width:var(--cell);
  height:var(--cell);
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  user-select:none;
  touch-action:none;
}

.palette-tile{
  background:#8a8f98;
  color:#fff;
}

/* ===== 拖曳中的方塊 ===== */
.dragging{
  position:fixed;
  z-index:9999;
  pointer-events:none;
  transform:translate(-50%,-50%);
  background:#9aa0a8;
}

/* ===== 已放置的方塊 ===== */
.placed{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  background:#6e7680;
}
</style>
</head>

<body>
<div class="wrapper">
  <h1>大調音階・三和弦級數練習</h1>

  <!-- 7×3 -->
  <div class="grid" id="grid">
    <!-- 21 格 -->
    <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
    <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
    <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
  </div>

  <!-- 音名 -->
  <div class="palette" id="palette">
    <div class="row">
      <div class="tile palette-tile" data-note="C">C</div>
      <div class="tile palette-tile" data-note="D">D</div>
      <div class="tile palette-tile" data-note="E">E</div>
      <div class="tile palette-tile" data-note="F">F</div>
      <div class="tile palette-tile" data-note="G">G</div>
      <div class="tile palette-tile" data-note="A">A</div>
      <div class="tile palette-tile" data-note="B">B</div>
    </div>

    <div class="row">
      <div class="tile palette-tile" data-note="C#">C#</div>
      <div class="tile palette-tile" data-note="D#">D#</div>
      <div class="tile palette-tile" data-note="E#">E#</div>
      <div class="tile palette-tile" data-note="F#">F#</div>
      <div class="tile palette-tile" data-note="G#">G#</div>
      <div class="tile palette-tile" data-note="A#">A#</div>
      <div class="tile palette-tile" data-note="B#">B#</div>
    </div>

    <div class="row">
      <div class="tile palette-tile" data-note="Cb">Cb</div>
      <div class="tile palette-tile" data-note="Db">Db</div>
      <div class="tile palette-tile" data-note="Eb">Eb</div>
      <div class="tile palette-tile" data-note="Fb">Fb</div>
      <div class="tile palette-tile" data-note="Gb">Gb</div>
      <div class="tile palette-tile" data-note="Ab">Ab</div>
      <div class="tile palette-tile" data-note="Bb">Bb</div>
    </div>
  </div>
</div>

<script>
/* ===== 手機 touch 拖曳（穩定版）===== */
const cells = [...document.querySelectorAll('.cell')];
let dragEl = null;
let dragNote = null;
let overCell = null;
let fromCell = null; // ⭐ 新增：記住是從哪個格子拖出來的


function clearHighlight(){
  cells.forEach(c=>c.classList.remove('highlight'));
}

function findCell(x,y){
  const el = document.elementFromPoint(x,y);
  return el && el.classList.contains('cell') ? el : el?.closest('.cell');
}

document.getElementById('palette').addEventListener('touchstart',e=>{
  const t = e.target.closest('.palette-tile');
  if(!t) return;
  e.preventDefault();

  dragNote = t.dataset.note;
  dragEl = document.createElement('div');
  dragEl.className = 'tile dragging';
  dragEl.textContent = dragNote;
  document.body.appendChild(dragEl);
},{passive:false});

// ===== 已放置方塊：拖出即刪除 =====
document.addEventListener('touchstart', e => {
  const placed = e.target.closest('.placed');
  if (!placed) return;

  e.preventDefault();

  fromCell = placed.parentElement;
  dragNote = placed.textContent;

  dragEl = document.createElement('div');
  dragEl.className = 'tile dragging';
  dragEl.textContent = dragNote;
  document.body.appendChild(dragEl);

  placed.remove(); // ⭐ 先從格子拿掉
}, { passive: false });

  
document.addEventListener('touchmove',e=>{
  if(!dragEl) return;
  e.preventDefault();

  const touch = e.touches[0];
  dragEl.style.left = touch.clientX+'px';
  dragEl.style.top  = touch.clientY+'px';

  const cell = findCell(touch.clientX,touch.clientY);
  if(cell !== overCell){
    overCell = cell;
    clearHighlight();
    if(overCell) overCell.classList.add('highlight');
  }
},{passive:false});

document.addEventListener('touchend', e => {
  if (!dragEl) return;

  clearHighlight();

  if (overCell) {
    // ✅ 有放回某個格子 → 放進去
    overCell.innerHTML = '';
    const placed = document.createElement('div');
    placed.className = 'tile placed';
    placed.textContent = dragNote;
    overCell.appendChild(placed);
  }
  // ❌ 沒放在任何格子 → 直接消失（不做任何事）

  dragEl.remove();
  dragEl = null;
  dragNote = null;
  overCell = null;
  fromCell = null;
});

</script>
</body>
</html>
